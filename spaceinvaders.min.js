(function(d,a){function c(b,e,a){var c;d.each(a,function(a,b){"string"!==typeof b&&"number"!==typeof b&&"function"===typeof b&&(c=b)});d.getJSON(b+"?callback=?",{reverse:e},function(b){c(b.items)})}a.jaz=a.jaz||{};a.jaz.Highscore=function(b,a){this.gameId=b;this.url=a+"/"+this.gameId};a.jaz.Highscore.VERSION="0.0.1";a.jaz.Highscore.prototype={getHighest:function(b,a,d){c(this.url,!1,arguments)},getLowest:function(b,a,d){c(this.url,!0,arguments)},set:function(b,a,c){d.ajax({url:this.url,data:{player:b,
score:a,scope:c},dataType:"json",type:"POST",crossDomain:!0})}}})(jQuery,window);
window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(b){window.setTimeout(b,1E3/60)}}();
var ArcadeFont={alphabet:{A:"28,54,99,99,127,99,99",B:"63,99,99,63,99,99,63",C:"62,99,3,3,3,99,62",D:"31,51,99,99,99,51,31",E:"127,3,3,63,3,3,127",F:"63,3,3,31,3,3,3",G:"62,99,3,115,99,99,62",H:"99,99,99,127,99,99,99",I:"30,12,12,12,12,12,30",J:"96,96,96,96,96,99,62",K:"99,51,27,15,27,51,99",L:"3,3,3,3,3,3,127",M:"99,119,127,107,99,99,99",N:"99,103,111,127,123,115,99",O:"62,99,99,99,99,99,62",P:"63,99,99,99,63,3,3",Q:"62,99,99,99,123,51,94",R:"63,99,99,63,27,51,99",S:"62,99,3,62,96,99,62",T:"63,12,12,12,12,12,12",
U:"99,99,99,99,99,99,62",V:"99,99,99,99,54,28,8",W:"99,99,99,107,127,119,99",X:"99,119,62,28,62,119,99",Y:"51,51,51,30,12,12,12",Z:"127,112,56,28,14,7,127",a:"0,0,62,96,126,99,126",b:"3,3,3,63,99,99,63",c:"0,0,62,3,3,3,62",d:"96,96,96,126,99,99,126",e:"0,0,62,99,127,3,62",f:"56,12,30,12,12,12,12",g:"0,0,126,99,99,126,96,62",h:"3,3,3,63,99,99,99",i:"12,0,14,12,12,12,30",j:"24,0,28,24,24,24,24,14",k:"3,3,99,51,31,51,99",l:"14,12,12,12,12,12,30",m:"0,0,55,127,107,107,99",n:"0,0,31,51,51,51,51",o:"0,0,62,99,99,99,62",
p:"0,0,63,99,99,63,3,3",q:"0,0,126,99,99,126,96,96",r:"0,0,31,51,3,3,3",s:"0,0,62,3,62,96,63",t:"12,12,30,12,12,12,56",u:"0,0,99,99,99,99,126",v:"0,0,99,99,54,28,8",w:"0,0,99,107,107,127,54",x:"0,0,99,54,28,54,99",y:"0,0,99,99,99,126,96,62",z:"0,0,127,56,28,14,127"," ":"0,0,0,0,0,0,0",1:"12,14,12,12,12,12,63",2:"62,99,112,60,6,3,127",3:"126,48,24,60,96,99,62",4:"56,60,54,51,127,48,48",5:"127,3,63,96,96,99,62",6:"62,99,3,63,99,99,62",7:"127,96,48,24,12,12,12",8:"62,99,99,62,99,99,62",9:"62,99,99,126,96,99,62",
"0":"62,99,99,99,99,99,62","(":"24,12,6,6,6,12,24",")":"6,12,24,24,24,12,6","{":"24,12,12,6,12,12,24","}":"6,12,12,24,12,12,6","<":"48,24,12,6,12,24,48",">":"3,6,12,24,12,6,3","'":"24,24,12,0,0,0,0",'"':"102,102,51,0,0,0,0",".":"0,0,0,0,0,12,12","!":"12,12,12,12,0,0,12","-":"0,0,0,63,0,0,0","+":"0,12,12,63,12,12,0",",":"0,0,0,0,0,12,12,6",":":"0,12,12,0,0,12,12",";":"0,12,12,0,0,12,12,6","?":"62,99,48,24,12,0,12",$:"8,62,3,62,96,63,8","%":"67,99,48,24,12,102,98","&":"28,54,28,14,123,51,110","=":"0,0,63,0,63,0,0",
_:"0,0,0,0,0,0,127","^":"8,28,54,99,0,0,0","\u00b0":"60,102,102,60,0,0,0","\u20ac":"62,99,15,3,15,99,62","#":"20,20,62,20,62,20,20","*":"0,54,28,127,28,54,0","/":"64,96,48,24,12,6,2","\\":"2,6,12,24,48,96,64","[":"30,6,6,6,6,6,30","]":"60,48,48,48,48,48,60"},gutter:2,blueprint:function(b){var a=[],c,d,e,k,h;b=b.toUpperCase();for(e in b){c=this.alphabet[b[e]].split(",");h=0;for(k=c.length;h<k;++h){d=EightBit.decodeNumber(c[h],7);a[h]||(a[h]="");a[h]+=d;for(d=this.gutter;d--;)a[h]+="0"}}return a.join("\n")}},
EightBit={encode:function(b){var a=[];b=b.split("\n");var c,d;c=0;for(d=b.length;c<d;++c)a.push(this.encodeLine(b[c]));return a.join(",")},decode:function(b,a){var c=[],d=b.split(","),e,k;e=0;for(k=d.length;e<k;++e)c.push(this.decodeNumber(d[e],a));return c.join("\n")},encodeLine:function(b){var a=0,c;for(c in b)a+="1"===b[c]?Math.pow(2,c):0;return a},decodeNumber:function(b,a){var c="",d,e;for(d=a;d--;)e=Math.pow(2,d),e<=b?(b-=e,c="1"+c):c="0"+c;return c}},redraw=function(b){var a=this.element.getContext("2d"),
c=this.blueprint.split("\n"),d,e;a.fillStyle="rgba("+this.color+", 1)";for(var k=0,h=c.length;k<=h;++k){d=c[k]||"";for(var t=0,q=d.length;t<=q;++t)e=d[t],"1"===e&&(a.fillRect(Math.round(this.x+this.pixelSize*t),Math.round(this.y+this.pixelSize*k),this.pixelSize,this.pixelSize),b&&(this.boundingBox.width=Math.max(this.boundingBox.width,this.pixelSize*t+this.pixelSize)));b&&(this.boundingBox.height+=this.pixelSize)}},isHit=function(b){var a=this.boundingBox,c=b.boundingBox;return this.y+a.height<b.y||
this.y>b.y+c.height||this.x+a.width<b.x||this.x>b.x+c.width?!1:!0},explode=function(b){for(var a,c=this.blueprint.split("\n"),d,e=0,k=c.length;e<=k;++e){a=c[e]||"";for(var h=0,t=a.length;h<=t;++h)if(d=a[h],"1"===d){d=this.color.split(",");for(var q=0;q<d.length;++q)d[q]=Math.round(parseInt(d[q],10)+80*Math.random()-40),d[q]=Math.min(255,d[q]),d[q]=Math.max(0,d[q]);b.push(new Particle(this.element,{color:d.join(","),pixelSize:this.pixelSize,x:Math.round(this.x+this.pixelSize*h),y:Math.round(this.y+
this.pixelSize*e),velX:380*Math.random()-200,velY:280*-Math.random(),gravity:100,drag:0.96,fade:0.01+0.01*Math.random()}))}}},Text=function(b,a,c){c=c||{};$.extend(this,c);this.element=b;this.setText(a)};Text.prototype.redraw=redraw;Text.prototype.explode=explode;Text.prototype.setText=function(b){this.boundingBox={width:0,height:0};this.blueprint=ArcadeFont.blueprint(b.toString());this.redraw(!0)};
var Canon=function(b,a){a=a||{};$.extend(this,a);this.blueprint=EightBit.decode(this.blueprint,this.base);this.element=b;this.boundingBox={width:0,height:0};this.redraw(!0)};Canon.prototype.redraw=redraw;Canon.prototype.isHit=isHit;Canon.prototype.explode=explode;var Invader=function(b,a){var c=document.createElement("canvas");a=a||{};this.points=1;$.extend(this,a);c.width=this.maxWidth*this.pixelSize;c.height=this.maxHeight*this.pixelSize;this.element=b;this.boundingBox={width:0,height:0};this.redraw(!0)};
Invader.prototype.redraw=redraw;Invader.prototype.shoot=function(b,a){return new Bullet(this.element,{speed:b,color:"255, 255, 255",pixelSize:a,x:this.x+this.boundingBox.width/2,y:this.y+this.boundingBox.height})};Invader.prototype.explode=explode;Invader.prototype.isHit=isHit;var Bullet=function(b,a){this.canvas=b;this.ctx=b.getContext("2d");$.extend(this,a);this.boundingBox={width:this.pixelSize,height:this.pixelSize}};
Bullet.prototype.update=function(b){this.y+=this.speed*b;this.ctx.fillStyle="rgba("+this.color+", 1)";this.ctx.fillRect(Math.round(this.x),Math.round(this.y),this.pixelSize,this.pixelSize);return this.y>this.canvas.height||this.y<-this.pixelSize?!1:!0};Bullet.prototype.isHit=isHit;
Bullet.prototype.explode=function(b){for(var a=this.pixelSize;a--;)for(var c=this.pixelSize;c--;){colors=[255,255,255];for(var d=3;d--;)colors[d]=Math.round(255,25*-Math.random());b.push(new Particle(this.canvas,{color:colors.join(","),pixelSize:this.pixelSize,x:Math.round(this.x+a),y:Math.round(this.y+c),velX:380*Math.random()-200,velY:280*-Math.random(),gravity:100,drag:0.95,fade:0.01+0.01*Math.random()}))}};
var Particle=function(b,a){var c=b.getContext("2d");this.size=a.pixelSize;this.boundingBox={width:this.size,height:this.size};this.alpha=1;this.update=function(b){a.velY*=a.drag;a.velX*=a.drag;a.y+=(a.velY+a.gravity)*b;a.x+=a.velX*b;this.alpha-=a.fade||0;this.size*=a.shrink||1;c.fillStyle="rgba("+a.color+", "+this.alpha+")";c.fillRect(Math.round(a.x),Math.round(a.y),this.size,this.size);return 0.01<=this.alpha}},Game=function(b,a){function c(){var c="255,151,94 255,182,240 195,255,232 182,255,252 197,255,182 255,242,117".split(" "),
d,L=0,f=0,h=0,k;$.each(a.invaders,function(g,e){d=[];if(!(++h>C+2)){k=c[Math.floor(Math.random()*c.length)];for(var j=0;j<a.numPerRow;++j)f=y+j*(a.gutter+M*a.pixelSize),d.push(new Invader(b,{blueprint:EightBit.decode(e,a.invaderBase),color:k,pixelSize:a.pixelSize,x:f,y:a.offset+L*M*a.pixelSize})),N=Math.max(f,N),++D;n.push(d);++L}});g||(g=new Canon(b,{blueprint:"32,112,1022,2047,2047,2047",base:11,color:"255,82,75",pixelSize:a.pixelSize,x:b.width/2,y:b.height-30}),$(window).on("keydown keyup",e));
5<C&&(E+=T,F+=U)}function d(a){a=$.inArray(a,v);-1<a&&v.splice(a,1)}function e(c){if(g){var l="keydown"===c.type,e=c.which;37===e||65===e?g.left=l:39===e||68===e?g.right=l:80===e&&l?(G=!G)?(H=new Date,I(),x.explode(p),d(x)):x=t("PAUSE"):32===e&&l&&(l=new Date,V<l-O&&(m.push(new Bullet(b,{speed:-W,color:"255, 255, 255",pixelSize:a.bulletSize,x:g.x+g.boundingBox.width/2,y:g.y})),O=l),z||c.preventDefault());w&&w.focus()}}function k(a){for(var b=n.length;b--;)for(var c=n[b].length;c--;)!1===a(n[b][c])&&
(n[b].splice(c,1),n[b].length||n.splice(b,1))}function h(){var a=Math.floor(Math.random()*n.length);return n[a][Math.floor(Math.random()*n[a].length)]}function t(a){a=new Text(b,a,{color:"205,212,75",pixelSize:2});a.x=(b.width-a.boundingBox.width)/2;a.y=(b.height-a.boundingBox.height)/2;v.push(a);return a}function q(){J.getHighest(X)}function X(a){function c(a,d){var e=new Text(b,a,{color:"205,212,75",pixelSize:2,y:d});e.x=(b.width-e.boundingBox.width)/2;v.push(e)}c("HIGHSCORE",20);$.each(a,function(a,
b){var d;d=(9>a?"0":"")+(a+1+".  ");d+=(b.player+"            ").slice(0,12)+" ";d+=("     "+b.score).slice(-6);c(d,25*a+120)})}function P(a){A+=a;u.setText(A);u.x=b.width-u.boundingBox.width-5}function I(){Y.clearRect(0,0,b.width,b.height);var e=new Date,l=(e-H)/1E3,n=!1,l=Math.min(50,l);if(!(100<l)){g&&(g.right?(g.x+=Q*l,g.x=Math.min(g.x,b.width-y-g.boundingBox.width)):g.left&&(g.x-=Q*l,g.x=Math.max(g.x,y)),g.redraw());k(function(a){a.x+=(B?1:-1)*F*l;a.redraw();if(B&&a.x+a.boundingBox.width>b.width-
y||!B&&a.x<y)n=!0});n&&(g&&k(function(b){b.y+=a.invaderVelY}),B=!B);for(var f=m.length;f--;)m[f].update(l)||(m.splice(f,1),++Z);for(f=r.length;f--;)r[f].update(l)||r.splice(f,1);for(f=p.length;f--;)p[f].update(l)||p.splice(f,1);k(function(a){for(var b=!0,c=m.length;c--;)b&&a.isHit(m[c])&&(P(a.points),a.explode(p),b=!1,m.splice(c,1),--D);return b});for(f=r.length;f--;)for(var u=m.length;u--;)r[f]&&r[f].isHit(m[u])&&(m.splice(u,1),r[f].explode(p),r.splice(f,1));for(f=r.length;f--;)g&&g.isHit(r[f])&&
(g.explode(p),g=null,r.splice(f,1));g&&(D&&Math.random()<E)&&r.push(h().shoot(aa,a.bulletSize));!D&&!p.length&&(++C,c());if(!z&&!g&&!p.length&&!m.length){var x=t("GAME OVER");z=!0;setTimeout(function(){x.explode(p);var a=$.inArray(x,v);-1<a&&v.splice(a,1);z=!0;var c=t("Enter your name:");w=$('<input type="text" style="position:absolute;left:-9999px" id="playerName">');$("body").append(w);w.focus().on("keyup",function(a){var e=w.val();s?(s.x=(b.width-s.boundingBox.width)/2,s.setText(e)):(s=new Text(b,
e,{color:"205,212,75",pixelSize:2}),s.x=(b.width-s.boundingBox.width)/2,s.y=(b.height-s.boundingBox.height)/2+20,v.push(s));13===a.which&&(w.off("keyup").remove(),c.explode(p),d(c),s.explode(p),d(s),a=w.val(),J=new jaz.Highscore("space_invaders","http://85.214.144.70:8181"),a&&J.set(a,A),setTimeout(q,50))})},3E3)}if(j){j.x+=(K?1:-1)*a.mothership.speed*l;j.redraw();for(f=m.length;f--;)j.isHit(m[f])&&(P(j.points),j.explode(p),j=null,m.splice(f,1),R=e);if(j&&(j.x>b.width+20||j.x<j.boundingBox.width-
20))j=null}else if((S<=C||z)&&R<e-1E3*a.mothership.minTime&&Math.random()<a.mothership.probability)K=0.5>Math.random(),j=new Invader(b,{blueprint:EightBit.decode(a.mothership.blueprint,a.mothership.base),color:a.mothership.color,pixelSize:a.pixelSize,x:b.width,y:6,points:10}),j.x=K?-j.boundingBox.width:b.width,++S;for(f=v.length;f--;)v[f].redraw()}H=e;G&&window.requestAnimFrame(I)}var M=12,n=[],m=[],r=[],p=[],A=0,u,Z=0,C=1,D=0,B=!0,F=40,U=20,Q=130,V=500,O=0,W=100,aa=100,j,S=0,R=new Date,K,H=new Date,
Y=b.getContext("2d"),N=0,y=a.gutter,E=0.075,T=0.05,G=!0,z=!1,v=[],x,s,w,J,g;u=new Text(b,A,{color:"205,212,75",pixelSize:2,x:b.width-50,y:5});u.x=b.width-u.boundingBox.width-5;v.push(u);c();I()};
$(document).ready(function(){var b=document.getElementById("game");b.width=500;b.height=400;new Game(b,{pixelSize:3,bulletSize:3,numPerRow:6,invaders:{"#invader8":"260,136,508,886,2047,1533,1285,216,","#invader2":"240,1020,4095,3687,4095,4095,360,660,1122,0","#invader3":"144,2553,2925,3069,4095,240,504,612,1026","#invader6":"240,2046,4095,3687,4095,504,876,3075","#invader1":"264,144,1020,1020,3951,3069,3069,144,264,0","#invader7":"260,1161,1533,1911,1022,1022,260,514"},invaderVelY:10,invaderBase:12,
gutter:20,offset:60,mothership:{blueprint:"48,252,1023,819,510",base:10,color:"232,36,16",offset:10,minTime:15,probability:0.004,speed:60,points:20}})});
